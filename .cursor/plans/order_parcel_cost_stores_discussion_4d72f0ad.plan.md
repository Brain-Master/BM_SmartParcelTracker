---
name: Order Parcel Cost Stores Discussion
overview: Финальный сводный план решений по заказам, посылкам, стоимости, магазинам, службам доставки, валютам и курсам, статусам товаров (BM Smart Parcel Tracker).
todos: []
isProject: false
---

# Финальный план: заказы, посылки, стоимость, справочники, статусы

Документ объединяет все принятые решения по логике заказов, посылок, формированию стоимости, справочникам (магазины, службы доставки, валюты) и статусам товаров. Используется как единый источник правды при реализации.

---

## Сводка решений

| № | Тема | Решение |
|---|------|--------|
| 1 | Удаление заказа и посылки | Вариант C (сторнирование): нет посылок — жёсткое удаление; есть только эксклюзивные — удалить их и заказ; есть общие — soft-delete заказа, в UI «(заказ удалён)». |
| 2 | Стоимость заказа | Гибрид: итог = товары + доставка + пошлины; создание с товарами одним запросом (1A) + пересчёт при изменениях (1B). |
| 3 | Магазины (платформы) | Вариант A: удаление запрещено при наличии заказов; уведомление в UI. |
| 4 | Службы доставки | Вариант A: удаление запрещено при наличии посылок; уведомление в UI. |
| 5 | Валюты и курсы | Выбор источника; список валют с чекбоксами видимости; сохранение курса и даты для оффлайна. |
| 6 | Статусы товаров в заказе | 10 статусов (от «Ждёт оплаты» до «Refunded»); связь с посылками; при отсутствии посылки — только ранние или финальные статусы. |

---

## 1. Логика удаления заказа и привязанные посылки — вариант C (принят)

**Решение:** принят **вариант C (сторнирование)**. Варианты A (только жёсткое удаление), B (запрет при наличии посылок), D (без soft-delete при общих) не приняты.

### Поведение

- **Нет посылок у заказа** → **жёсткое удаление** заказа и его `order_items` (каскад).
- **Есть посылки:**
  - **Эксклюзивные посылки** (все товары в посылке только из этого заказа) → удалять **жёстко** (посылка + parcel_items).
  - **Общие посылки** (есть товары из других заказов) → заказ **не удалять**, выставить **мягкое удаление**: `orders.deleted_at`. В UI в составе посылки для строк этого заказа — пометка «(заказ удалён)» / «(сторнирован)».

### Реализация

- **Бэкенд** [backend/app/services/order_service.py](backend/app/services/order_service.py): в методе удаления заказа определять эксклюзивные посылки; удалять их; при оставшихся общих — выставлять `deleted_at`, иначе — жёстко удалять заказ.
- **Модель** [backend/app/models/order.py](backend/app/models/order.py): поле `deleted_at: Mapped[datetime | None]` + миграция Alembic.
- **API:** список заказов по умолчанию — `deleted_at IS NULL`; в составе посылки — флаг/метка «удалён» по заказу.
- **Фронт:** для строк заказа с `deleted_at != null` в карточке посылки показывать «(заказ удалён)» или «(сторнирован)».

---

## 2. Формирование стоимости заказа — гибридный подход (принят)

**Решение:** **гибрид**: создание заказа с товарами одним запросом (1A) + пересчёт итогов при любом изменении товаров или доставки/пошлин (1B). Ручное поле «Стоимость заказа» убирается. **Итог = товары + доставка + пошлины.**

### Формула

- **price_original** (валюта заказа) = Σ (price_per_item × quantity_ordered) + shipping_cost + customs_cost.
- **price_final_base** = price_original × exchange_rate_frozen (базовая валюта пользователя).

### Часть 1: Создание с товарами (1A)

- POST `/api/orders`: опциональный массив `order_items` в теле; `price_original` и `price_final_base` в `OrderCreate` — опциональные.
- При непустом `order_items`: создать заказ и позиции в одной транзакции, вычислить и записать price_original и price_final_base. При пустом/отсутствии — допускается заказ без суммы (0) с пересчётом при добавлении товаров.
- **Фронт:** форма с полями «Доставка» и «Пошлины»; итог только вычисляемый; при создании — отправка заказа с массивом товаров одним запросом.

### Часть 2: Пересчёт при изменениях (1B)

- **Триггеры:** создание/обновление/удаление позиции (`/api/order-items`) и обновление заказа (PUT `/api/orders/{id}`) — после операции пересчитать по текущим позициям и обновить у заказа `price_original` и `price_final_base`.
- **Реализация:** функция `recalculate_order_totals(db, order_id)` в [backend/app/services/order_service.py](backend/app/services/order_service.py); вызывать из create_order (при order_items), update_order и из [backend/app/services/order_item_service.py](backend/app/services/order_item_service.py) после create/update/delete позиции.

### Файлы

- Схемы [backend/app/schemas/order.py](backend/app/schemas/order.py): OrderCreate — опциональные price_original/price_final_base, опционально `order_items`.
- OrderForm: убрать «Стоимость заказа»; добавить «Доставка» и «Пошлины»; вычисляемый итог; при создании — один запрос с товарами.

---

## 3. Магазины (платформы) — вариант A (принят)

**Решение:** **вариант A.** Создание магазинов разрешено. Удаление запрещено, если есть заказы с этим магазином — показываем уведомление.

- **Бэкенд:** при DELETE магазина проверять заказы по `orders.platform` (или по связи Store). При наличии — 409/400 с сообщением.
- **Фронт:** при ошибке удаления — уведомление: «Удалить нельзя: есть заказы, привязанные к этому магазину».

---

## 4. Службы доставки — вариант A (принят)

**Решение:** **вариант A.** Аналогично магазинам: удаление запрещено при наличии посылок с этой службой; уведомление.

- **Бэкенд:** при DELETE службы доставки проверять записи в `parcels` (или связь). При наличии — 409/400.
- **Фронт:** уведомление: «Удалить нельзя: есть посылки с этой службой доставки».

---

## 5. Валюты и курсы — источник, оффлайн, видимость (принято)

**Решение:** Учёт отсутствия интернета и сбоев ЦБ; выбор источника курсов; список всех полученных валют с чекбоксами видимости; для активных валют — сохранение курса и даты актуальности (оффлайн).

### Поведение

1. **Источник курсов:** в настройках выбор (ЦБ РФ, другой API, ручной ввод). При недоступности — использовать сохранённые курсы и помечать по дате как устаревшие.
2. **Список валют:** в настройках показывать все полученные валюты/курсы; чекбокс «Показывать в приложении» (активные). В селектах заказа и отчётах — только активные.
3. **Оффлайн:** для каждой активной валюты сохранять **курс** и **дату актуальности**. При оффлайне/ошибке API — использовать сохранённый курс, показывать дату («Курс на 12.02.2026») и при необходимости предупреждение об устаревании.

### Реализация (концепт)

- Хранить: источник курсов; список активных валют; для каждой — курс к базовой и дата. При успешном запросе к API — обновлять кэш.
- API курсов: при недоступности источника возвращать кэш + флаг/дату.
- Фронт: экран «Валюты и курсы» — выбор источника, список валют с чекбоксами, курс и дата, кнопка «Обновить курсы».

---

## 6. Статусы товаров в заказе и связь с посылками (принято)

**Решение:** Для позиции заказа (order_item) — фиксированный набор статусов в `order_items.item_status`. Учтены этапы до отправки, split по посылкам и случай «посылки нет».

### Список статусов (OrderItemStatus)

| Код (enum) | Отображение (RU) | Пояснение |
|------------|------------------|-----------|
| Waiting_Payment | Ждёт оплаты | Ожидание оплаты |
| Payment_Verification | Проверка платежа | Платёж проверяется |
| Seller_Packing | Сборка продацом | Продавец собирает заказ |
| Partially_Shipped | Частично отправлено | Split: не все посылки отправлены |
| Shipped | Отправлено | Вся позиция отправлена |
| Partially_Received | Частично получено | Split: не все посылки получены |
| Received | Получено | Вся позиция получена |
| Cancelled | Отменено | Позиция отменена |
| Dispute_Open | Dispute открыт | Спор открыт |
| Refunded | Возврат | Возврат оформлен |

### Связь с посылками

- **Нет посылки:** допустимы статусы до отправки (Waiting_Payment, Payment_Verification, Seller_Packing), а также Cancelled, Dispute_Open, Refunded. Статусы доставки (Shipped и т.д.) — только при наличии посылок или ручной установке.
- **Есть посылки:** Partially_Shipped / Shipped / Partially_Received / Received определяются по данным parcel_items и статусам посылок. Рекомендуется хранить `item_status` в БД и обновлять его при изменении посылок/parcel_items (все доставлены → Received; часть → Partially_Received и т.д.).

### Изменения в коде

- **Enum** [backend/app/models/enums.py](backend/app/models/enums.py): расширить OrderItemStatus (добавить новые значения; Waiting_Shipment заменить/маппинг на Seller_Packing).
- **Миграция:** обновить тип/значения для `order_items.item_status`.
- **Сервис:** при обновлении посылок/parcel_items при необходимости пересчитывать `item_status` затронутых order_items.
- **Фронт:** выбор и отображение статуса из списка; при отсутствии посылки не предлагать статусы доставки без данных.

---

## 7. Дальнейшие разделы

Фильтры, отчёты и прочие темы при необходимости дополняются в этом же файле или в отдельных планах.
